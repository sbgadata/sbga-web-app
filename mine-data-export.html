<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Añadir datos de Exportación | SBGA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>

  <body class="bg-gray-100">
    <script>
      const usuario = JSON.parse(localStorage.getItem("usuario"));
      if (!usuario) window.location.href = "index.html";
    </script>

    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <div id="sidebar-container"></div>
      <script>
        fetch("aside.html")
          .then((res) => res.text())
          .then((data) => (document.getElementById("sidebar-container").innerHTML = data))
          .catch((err) => console.error("Error cargando el aside:", err));
      </script>

      <script>
        function logoutConfirm() {
          Swal.fire({
            title: "¿Cerrar sesión?",
            text: "Tu sesión se cerrará.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#aaa",
            confirmButtonText: "Sí, salir",
            cancelButtonText: "Cancelar",
          }).then((r) => {
            if (r.isConfirmed) {
              localStorage.removeItem("usuario");
              window.location.href = "index.html";
            }
          });
        }
      </script>

      <main class="flex-1 p-8 bg-gray-50">
        <div class="mb-6">
          <h1 class="text-2xl font-bold text-gray-800">Datos Operativos</h1>
          <p class="text-sm text-gray-500">Complete los datos de exportación</p>
        </div>

        <!-- FORM -->
        <form id="form-operativo" class="bg-white p-6 rounded-lg shadow grid grid-cols-12 gap-5">
          <!-- Fila 1 -->
          <div class="col-span-12 md:col-span-5">
            <label for="mina_id" class="block text-sm font-medium text-gray-700">Mina *</label>
            <select id="mina_id" required class="h-11 w-full border border-gray-300 rounded px-3 focus:ring-2 focus:ring-blue-500">
              <option value="">Cargando minas...</option>
            </select>
          </div>

          <div class="col-span-12 sm:col-span-6 md:col-span-4">
            <label for="fecha_exportacion" class="block text-sm font-medium text-gray-700">Fecha de exportación *</label>
            <input type="date" id="fecha_exportacion" required class="h-11 w-full border border-gray-300 rounded px-3 focus:ring-2 focus:ring-blue-500" />
          </div>

          <div class="col-span-12 sm:col-span-6 md:col-span-3">
            <label for="delivery_number" class="block text-sm font-medium text-gray-700">Delivery number</label>
            <input type="text" id="delivery_number" placeholder="Ej: DO-000123" autocomplete="off" class="h-11 w-full border border-gray-300 rounded px-3 focus:ring-2 focus:ring-blue-500" />
          </div>

          <!-- Fila 2: Tarjetas iguales -->
          <div class="col-span-12 md:col-span-6">
            <div class="h-full border rounded-lg p-4 bg-gray-50">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-gray-800">Oro exportado (g)</h3>
                <span class="text-xs text-gray-500">usar punto o coma</span>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label for="prerefined_exported_gold" class="block text-sm text-gray-700">Prerefined (g)</label>
                  <input type="number" id="prerefined_exported_gold" step="0.001" min="0" inputmode="decimal" placeholder="0.000" class="h-11 w-full border border-gray-300 rounded px-3 focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                  <label for="fine_exported_gold" class="block text-sm text-gray-700">Fine (g)</label>
                  <input type="number" id="fine_exported_gold" step="0.001" min="0" inputmode="decimal" placeholder="0.000" class="h-11 w-full border border-gray-300 rounded px-3 focus:ring-2 focus:ring-blue-500" />
                </div>
              </div>
            </div>
          </div>

          <div class="col-span-12 md:col-span-6">
            <div class="h-full border rounded-lg p-4 bg-gray-50">
              <h3 class="font-semibold text-gray-800 mb-3">Notificador</h3>
              <input type="text" id="notifier" placeholder="Nombre de quien notifica" autocomplete="off" class="h-11 w-full border border-gray-300 rounded px-3 focus:ring-2 focus:ring-blue-500" />
              <p class="text-xs text-gray-500 mt-2">Persona o entidad que notifica el envío/exportación.</p>
            </div>
          </div>

          <!-- Fila 3 -->
          <div class="col-span-12 sm:col-span-6 md:col-span-3">
            <label for="paso1_exportacion" class="block text-sm font-medium text-gray-700">Exportación Paso 1</label>
            <input type="number" id="paso1_exportacion" step="1" min="0" inputmode="numeric" class="h-11 w-full border border-gray-300 rounded px-3 focus:ring-2 focus:ring-blue-500" />
          </div>

          <div class="col-span-12 sm:col-span-6 md:col-span-3">
            <label for="paso2_exportacion" class="block text-sm font-medium text-gray-700">Exportación Paso 2</label>
            <input type="number" id="paso2_exportacion" step="1" min="0" inputmode="numeric" class="h-11 w-full border border-gray-300 rounded px-3 focus:ring-2 focus:ring-blue-500" />
          </div>

          <div class="col-span-12 sm:col-span-6 md:col-span-3">
            <label for="refinador" class="block text-sm font-medium text-gray-700">Refinador</label>
            <select id="refinador" class="h-11 w-full border border-gray-300 rounded px-3 focus:ring-2 focus:ring-blue-500">
              <option value="">Seleccione refinador</option>
              <option value="MKS">MKS</option>
              <option value="Metalor">Metalor</option>
              <option value="ARGOR">ARGOR</option>
            </select>
          </div>

          <div class="col-span-12 sm:col-span-6 md:col-span-3">
            <label for="comprador" class="block text-sm font-medium text-gray-700">Comprador</label>
            <select id="comprador" class="h-11 w-full border border-gray-300 rounded px-3 focus:ring-2 focus:ring-blue-500">
              <option value="">Seleccione comprador</option>
              <option value="Chopard">Audemars</option>
              <option value="Prailine">Piguet</option>
              <option value="Cartier">Cartier</option> 
              <option value="Chopard">Chopard</option> 
            </select>
          </div>

          <!-- Fila 4 -->
          <div class="col-span-12 md:col-span-9">
            <label for="comentario_exportacion" class="block text-sm font-medium text-gray-700">Comentario exportación</label>
            <textarea id="comentario_exportacion" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500"></textarea>
          </div>

          <!-- Botones -->
          <div class="col-span-12 md:col-span-3 flex items-end justify-end gap-3">
            <button type="reset" class="h-11 px-4 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Cancelar</button>
            <button type="submit" class="h-11 px-6 bg-blue-600 text-white rounded hover:bg-blue-700">Guardar</button>
          </div>
        </form>
      </main>

      <!-- Cargar minas -->
      <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwrqoyq40zHZ4ESTSRSaknEy0-calbBxLfmpKJZ4GruiQQKSxRCfjAgfC6QO1QqBrkH/exec";

        async function cargarMinas() {
          const select = document.getElementById("mina_id");
          select.disabled = true;
          select.innerHTML = '<option value="">Cargando minas...</option>';

          const norm = (s) =>
            (s || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toLowerCase();

          try {
            const res = await fetch(GAS_URL, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded;charset=utf-8" },
              body: "action=obtener_minas",
            });
            if (!res.ok) throw new Error("Solicitud fallida (" + res.status + ")");
            const result = await res.json();
            if (!result.success) throw new Error(result.error || "Error al obtener minas");

            const minas = Array.isArray(result.minas) ? result.minas : [];
            const porNombre = {};
            minas.forEach((m) => {
              if (!m || !m.nombre) return;
              const key = norm(m.nombre);
              const ts = new Date(m.timestamp || 0).getTime();
              if (!porNombre[key] || ts > new Date(porNombre[key].timestamp || 0).getTime()) {
                porNombre[key] = m;
              }
            });

            const minasUnicas = Object.values(porNombre)
              .filter((m) => m.id && String(m.id).trim() !== "")
              .sort((a, b) => norm(a.nombre).localeCompare(norm(b.nombre)));

            if (!minasUnicas.length) {
              select.innerHTML = '<option value="">No hay minas disponibles</option>';
              select.disabled = false;
              return;
            }

            select.innerHTML = '<option value="">Seleccione una mina</option>';
            minasUnicas.forEach((mina) => {
              const option = document.createElement("option");
              option.value = mina.id;
              option.textContent = mina.nombre || "(sin nombre)";
              select.appendChild(option);
            });
          } catch (err) {
            console.error("Error al cargar minas:", err);
            Swal.fire("Error", "No se pudieron cargar las minas", "error");
            select.innerHTML = '<option value="">Error al cargar minas</option>';
          } finally {
            select.disabled = false;
          }
        }
        cargarMinas();
      </script>

      <!-- Guardar -->
      <script>
        const toFloatOrNull = (value) => {
          const s = String(value ?? "").replace(",", ".").trim();
          if (!s) return null;
          const n = parseFloat(s);
          return Number.isFinite(n) ? n : null;
        };

        document.getElementById("form-operativo").addEventListener("submit", async (e) => {
          e.preventDefault();

          const data = {
            action: "guardar_operativo",
            mina_id: document.getElementById("mina_id").value,
            fecha_exportacion: document.getElementById("fecha_exportacion").value,
            comentario_exportacion: document.getElementById("comentario_exportacion").value,
            paso1_exportacion: toFloatOrNull(document.getElementById("paso1_exportacion").value),
            paso2_exportacion: toFloatOrNull(document.getElementById("paso2_exportacion").value),
            refinador: document.getElementById("refinador").value,
            comprador: document.getElementById("comprador").value,
            delivery_number: document.getElementById("delivery_number").value,
            prerefined_exported_gold: toFloatOrNull(document.getElementById("prerefined_exported_gold").value),
            fine_exported_gold: toFloatOrNull(document.getElementById("fine_exported_gold").value),
            notifier: document.getElementById("notifier").value,
          };

          if (!data.mina_id) return Swal.fire("Validación", "Seleccione una mina", "warning");
          if (!data.fecha_exportacion) return Swal.fire("Validación", "Ingrese la fecha de exportación", "warning");

          try {
            Swal.fire({ title: "Guardando...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const res = await fetch(GAS_URL, {
              method: "POST",
              headers: { "Content-Type": "text/plain;charset=utf-8" },
              body: JSON.stringify(data),
            });

            const result = await res.json();
            Swal.close();

            if (result.success) {
              Swal.fire("Éxito", "Datos operativos guardados correctamente", "success");
              document.getElementById("form-operativo").reset();
            } else {
              Swal.fire("Error", result.error || "Error al guardar", "error");
            }
          } catch (err) {
            Swal.close();
            Swal.fire("Error", "No se pudo conectar con el servidor", "error");
          }
        });
      </script>
    </div>

    <!-- User name/rol después del aside -->
    <script>
      const _interval = setInterval(() => {
        const n = document.getElementById("userName");
        const r = document.getElementById("userRol");
        if (n && r) {
          n.innerText = usuario.nombre || "";
          r.innerText = usuario.rol || "";
          clearInterval(_interval);
        }
      }, 100);
    </script>
  </body>
</html>
