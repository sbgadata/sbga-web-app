<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lista de miembros | SBGA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-gray-100">
  <script>
    const usuario = JSON.parse(localStorage.getItem("usuario"));
    if (!usuario) window.location.href = "index.html";
  </script>

  <div class="flex min-h-screen relative">
    <!-- Loader -->
    <div id="loader" class="absolute inset-0 flex justify-center items-center bg-white/70 backdrop-blur-[1px] z-10">
      <div class="flex flex-col items-center gap-2">
        <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
          viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <p class="text-sm text-gray-600">Cargando miembros...</p>
      </div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar-container"></div>
    <script>
      fetch('aside.html')
        .then(res => res.text())
        .then(data => {
          document.getElementById('sidebar-container').innerHTML = data;
          // ya existen en el DOM
          const userNameEl = document.getElementById("userName");
          const userRolEl = document.getElementById("userRol");
          if (userNameEl) userNameEl.innerText = usuario?.nombre ?? '';
          if (userRolEl) userRolEl.innerText = usuario?.rol ?? '';
        })
        .catch(err => console.error('Error cargando el aside:', err));
    </script>

    <!-- Contenido principal -->
    <main class="p-8 w-full">
      <div class="flex flex-col gap-4 mb-6 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 class="text-2xl font-bold text-gray-800">Lista de Miembros</h1>
          <p class="text-sm text-gray-500">Resumen de miembros registrados</p>
        </div>
        <button onclick="window.location.href='new-member.html'"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow transition">
          + Nuevo Miembro
        </button>
      </div>

      <!-- Barra con filtro -->
      <div class="relative mb-6">
        <input
          type="text"
          id="filtroGlobal"
          placeholder="Buscar (Empresa, Tipo o Pa√≠s)..."
          class="w-full border border-gray-300 px-4 py-2 rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
        <span class="absolute right-4 top-2.5 text-gray-400 pointer-events-none">üîç</span>
      </div>

      <!-- Tabla -->
      <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm text-left text-gray-700">
            <thead class="bg-gray-100 text-gray-700">
              <tr>
                <th class="px-4 py-3 font-semibold">Empresa</th>
                <th class="px-4 py-3 font-semibold">Tipo</th>
                <th class="px-4 py-3 font-semibold">Pa√≠s</th>
              </tr>
            </thead>
            <tbody id="tablaMiembros">
              <!-- Cargado por JS -->
            </tbody>
          </table>
        </div>
        <div id="emptyState" class="hidden p-8 text-center text-gray-500">No se encontraron miembros.</div>
      </div>
    </main>
  </div>

  <script>
    // Utilidad: toma el primer valor disponible seg√∫n una lista de posibles claves
    function getVal(obj, keys) {
      for (const k of keys) {
        const v = obj?.[k];
        if (v !== undefined && v !== null && String(v).trim() !== "") return v;
      }
      return "";
    }

    async function cargarMiembros() {
      const loader = document.getElementById("loader");
      loader.style.display = "flex";

      try {
        const res = await fetch("https://script.google.com/macros/s/AKfycbwrqoyq40zHZ4ESTSRSaknEy0-calbBxLfmpKJZ4GruiQQKSxRCfjAgfC6QO1QqBrkH/exec?action=obtener_miembros");
        const data = await res.json();

        if (data.success && Array.isArray(data.miembros)) {
          // Normalizamos a solo los tres campos visibles
          const normalizados = data.miembros.map(m => ({
            empresa: getVal(m, ["nombre_empresa", "empresa", "Empresa", "Nombre empresa"]),
            tipo: getVal(m, ["tipo_miembro", "tipo", "Tipo", "Tipo de miembro"]),
            pais: getVal(m, ["pais", "Pa√≠s", "country", "Country"])
          }));

          renderizarTabla(normalizados);

          // Filtro sobre las 3 columnas visibles
          const input = document.getElementById("filtroGlobal");
          input.addEventListener("input", () => {
            const q = input.value.toLowerCase();
            const filtrados = normalizados.filter(m =>
              (m.empresa || "").toLowerCase().includes(q) ||
              (m.tipo || "").toLowerCase().includes(q) ||
              (m.pais || "").toLowerCase().includes(q)
            );
            renderizarTabla(filtrados);
          });
        } else {
          throw new Error("Error al obtener miembros");
        }
      } catch (err) {
        Swal.fire("Error", err.message, "error");
      } finally {
        loader.style.display = "none";
      }
    }

    function renderizarTabla(miembros) {
      const tbody = document.getElementById("tablaMiembros");
      const empty = document.getElementById("emptyState");
      tbody.innerHTML = "";

      if (!miembros.length) {
        empty.classList.remove("hidden");
        return;
      }
      empty.classList.add("hidden");

      // Construimos filas
      const rows = miembros.map(m => `
        <tr class="border-t hover:bg-gray-50 transition">
          <td class="px-4 py-2">${m.empresa || ""}</td>
          <td class="px-4 py-2">${m.tipo || ""}</td>
          <td class="px-4 py-2">${m.pais || ""}</td>
        </tr>
      `).join("");

      tbody.innerHTML = rows;
    }

    // Iniciar
    cargarMiembros();
  </script>
</body>

</html>
